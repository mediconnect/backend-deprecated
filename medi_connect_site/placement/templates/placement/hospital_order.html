{% extends "customer_header.html" %}

{% block content %}

<div>
    <h3 id="timer"></h3>
</div>

{{error}}
<button type="button" class="btn btn-default" id="like-button">
    <span style="font-size:1.5em;" class="glyphicon glyphicon-star"></span>
</button>
<p id="like-statement">Bookmark this Hospital</p>

<br>

<p>Rank: {{rank}}</p>
<h4 class="media-heading">Hospital Name: {{hospital.name}}</h4>
<p>Introduction: {{hospital.introduction}}</p>
<p>Feedback: {{hospital.feedback_time}}</p>
<p>Price: {{hospital.price_range}}</p>
<p> 1st week: {{slots.0}} <input id="radio0" type="radio" name="slots" checked>Choose 1st W<br></p>
<p> 2nd week: {{slots.1}} <input id="radio1" type="radio" name="slots">Choose 2nd W<br></p>
<p> 3rd week: {{slots.2}} <input id="radio2" type="radio" name="slots">Choose 3rd W<br></p>
<p> 4th week: {{slots.3}} <input id="radio3" type="radio" name="slots">Choose 4th W<br></p>

{% if error %}
{{error}}
{% endif %}
<form action="{% url 'order_info_first' order_id=order_id slot_num=1 %}" method="post" id="order_placement_form">
    {% csrf_token %}
    <button class="btn btn-default" type="submit">Place Order</button>
</form>

<br>

<div class="container">
    <div class="row">
        <div class="col-md-8">
            <ul class="list-group" id="comments-container">
                {% for comment in comments %}
                <li class="list-group-item">{{comment.comment}}</li>
                {% endfor %}
            </ul>
        </div>
        <button class="btn btn-default" id="more-comment">Other Comments</button>
    </div>
</div>

<script type="text/javascript">
var hosp_id = {{hospital.id}};
$(function() {
    like(false);
});
$("#like-button").click(function() {
    like(true);
});

function like(mark) {
    var dis_id = {{disease.id}};
    $.ajax({
        url: "{% url 'like_hospital' %}",
        data: {
            "hospital_id": hosp_id,
            "disease_id": dis_id,
            "mark": mark,
        },
        dataType: 'json',
        success: function(data) {
            if (data.status == "liked") {
                $("#like-statement").text("You have MARKED this hospital, Click to unMark");
                $("#like-button span").attr("class", "glyphicon glyphicon-star-empty");
            } else {
                $("#like-statement").text("Bookmark this Hospital");
                $("#like-button span").attr("class", "glyphicon glyphicon-star");
            }
        }
    });
}

var id = {{order_id}};
$("#radio0").change(function() {
    if ( this.checked ) {
        $("#order_placement_form").attr("action", url_generator(id, 0));
    }
});
$("#radio1").change(function() {
    if ( this.checked ) {
        $("#order_placement_form").attr("action", url_generator(id, 1));
    }
});
$("#radio2").change(function() {
    if ( this.checked ) {
        $("#order_placement_form").attr("action", url_generator(id, 2));
    }
});
$("#radio3").change(function() {
    if ( this.checked ) {
        $("#order_placement_form").attr("action", url_generator(id, 3));
    }
});
function url_generator(order, num) {
    $("#order_placement_form").attr("action", Urls.order_info_first(order, num));
}

var page = 1;
$('#more-comment').click(function() {
    $.ajax({
        url: "{% url 'get_comment' %}",
        data: {
            "hospital_id": hosp_id,
            "page": page,
        },
        dataType: 'json',
        success: function(data) {
            if (data.status == "empty") {
                $('#more-comment').prop('value', 'No More Comments');
                $('#more-comment').prop('disabled', true);
            } else {
                $.each(data.comments, function(i, comment) {
                    $('#comments-container').append("<li class='list-group-item'>" + comment + "</li>");
                });
            }
        }
    });
    page += 1;
});

(function timer (offset) {
    setTimeout(function () {
        var timestamp = {{ time }};
        timestamp = 5 * 60 - timestamp - offset;
        var minutes =  Math.floor(timestamp / 60);
        var seconds =  Math.floor(timestamp % 60);
        document.getElementById("timer").innerHTML = "距离你的订单结束还有：" +  minutes + " : " + seconds;
        if (timestamp <= 0) {
            window.location = "{% url 'order_expire' %}";
        }
        timer(offset + 0.5);
    }, 500);
})(0)
</script>
{% endblock %}
